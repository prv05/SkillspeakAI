<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skill Speak AI - Admin Panel</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="dark">
    <script>
        if (!localStorage.getItem('jwtToken')) {
            window.location.href = 'index.html';
        }
    </script>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar-modern">
            <div class="sidebar-logo">SkillSpeak</div>
            <ul class="sidebar-menu">
                <li class="sidebar-item active" onclick="showAdminPanel('dashboard')"><i class="fas fa-tools"></i> <span>Admin Dashboard</span></li>
                <li class="sidebar-item" onclick="window.location.href='chat.html'"><i class="fas fa-comments"></i> <span>Chat</span></li>
                <li class="sidebar-item" onclick="showAdminPanel('user-monitoring')"><i class="fas fa-users"></i> <span>User Monitoring</span></li>
                <li class="sidebar-item" onclick="showAdminPanel('chat-monitoring')"><i class="fas fa-comments"></i> <span>Chat Monitoring</span></li>
                <li class="sidebar-item" onclick="showAdminPanel('user-suggestions')"><i class="fas fa-lightbulb"></i> <span>User Suggestions</span></li>
                <li class="sidebar-item" onclick="showAdminPanel('system-settings')"><i class="fas fa-cogs"></i> <span>System Settings</span></li>
                <li class="sidebar-item" onclick="showAdminPanel('admin-profile')"><i class="fas fa-user-cog"></i> <span>Admin Profile</span></li>
                <li class="sidebar-item" onclick="window.location.href='dashboard.html'"><i class="fas fa-arrow-left"></i> <span>Back to User Dashboard</span></li>
            </ul>
        </aside>
        <!-- Main Content -->
        <main class="main-modern">
            <div class="topbar">
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search users, chats, feedback..." id="adminSearchBar" />
                </div>
                <div class="topbar-actions">
                    <button class="topbar-btn" onclick="exportAdminReportPDF()"><i class="fas fa-download"></i> Export</button>
                    <div class="user-info" style="cursor: pointer;">
                        <span id="userAvatarContainer">
                            <i class="fas fa-user-circle" style="font-size:2rem;"></i>
                        </span>
                        <span class="user-name" id="userName">Admin</span>
                    </div>
                </div>
            </div>
            <!-- Admin Dashboard Panel -->
            <section id="dashboard-panel" class="admin-section active">
                <h1 class="dashboard-title">Admin Dashboard</h1>
                <p class="dashboard-subtitle">Overview of platform activity</p>
                <div class="stat-cards-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Users</div>
                        <div class="stat-value" id="totalUsers">-</div>
                        <div class="stat-desc"><span class="stat-up" id="todayUsers">-</span> today users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Admin Users</div>
                        <div class="stat-value" id="adminUsers">-</div>
                        <div class="stat-desc"><span class="stat-up" id="todayAdmins">-</span> today admins</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Chats</div>
                        <div class="stat-value" id="totalChats">-</div>
                        <div class="stat-desc"><span class="stat-up" id="todayChats">-</span> today chats</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Suggestions</div>
                        <div class="stat-value" id="totalSuggestFeedback">-</div>
                        <div class="stat-desc"><span class="stat-up" id="totalSuggestFeedbackToday">-</span> today</div>
                    </div>
                </div>
                <div class="analytics-row">
                    <div class="analytics-card">
                        <div class="analytics-header">
                            <span>User Growth</span>
                            <select id="userGrowthModeSelect">
                                <option value="week">Week</option>
                                <option value="month">Month</option>
                                <option value="year">Year</option>
                            </select>
                        </div>
                        <canvas id="adminUserChart" height="120"></canvas>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-header">
                            <span>Daily vs Non-Frequent Users</span>
                        </div>
                        <canvas id="userStreakChart" height="120"></canvas>
                    </div>
                </div>
                <!-- Recent Activity Section -->
                <section class="admin-section">
                  <h2 class="dashboard-title">Recent Activity</h2>
                    <table class="activity-table">
                        <thead>
                      <tr>
                        <th>Type</th>
                        <th>User</th>
                        <th>Detail</th>
                        <th>Time</th>
                      </tr>
                        </thead>
                    <tbody id="recentActivityTable"></tbody>
                    </table>
                </section>
            </section>
            <!-- User Monitoring Panel -->
            <section id="user-monitoring-panel" class="admin-section" style="display:none;">
                <h1 class="dashboard-title">User Monitoring</h1>
                <div class="admin-search-bar" style="display: flex; justify-content: flex-end; margin-bottom: 2rem; margin-top: 0.5rem;">
                    <button class="btn export-btn-pro" onclick="exportUsersPDF()">
                        <i class="fas fa-file-pdf"></i> Export Users PDF
                    </button>
                </div>
                <div id="usersTableContainer">
                    <table class="activity-table" id="usersTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <!-- Dynamic content will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </section>
            <!-- Chat Monitoring Panel -->
            <section id="chat-monitoring-panel" class="admin-section" style="display:none;">
                <h1 class="dashboard-title">Chat Monitoring</h1>
                <div class="admin-search-bar" style="display: flex; justify-content: flex-end; margin-bottom: 2rem; margin-top: 0.5rem;">
                    <button class="btn export-btn-pro" onclick="exportChatsPDF()">
                        <i class="fas fa-file-pdf"></i> Export Chats PDF
                    </button>
                </div>
                <div id="chatsTableContainer">
                    <table class="activity-table" id="chatsTable">
                        <thead>
                            <tr>
                                <th>Session Name</th>
                                <th>User Name</th>
                                <th>Date</th>
                                <th>Messages</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="chatsTableBody">
                            <!-- Dynamic content will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </section>
            <!-- User Suggestions Panel -->
            <section id="user-suggestions-panel" class="admin-section" style="display:none;">
                <h1 class="dashboard-title">User Suggestions</h1>
                <div class="admin-search-bar" style="display: flex; justify-content: flex-end; margin-bottom: 2rem; margin-top: 0.5rem;">
                    <button class="btn export-btn-pro" onclick="exportSuggestionsPDF()">
                        <i class="fas fa-file-pdf"></i> Export Suggestions PDF
                    </button>
                </div>
                <div id="suggestionTableContainer">
                    <table class="activity-table" id="suggestionTable">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Suggestion</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="suggestionTableBody">
                            <!-- Dynamic content will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </section>
            <!-- Admin Profile Panel -->
            <section id="admin-profile-panel" class="admin-section" style="display:none;">
                <h1 class="dashboard-title">Admin Profile</h1>
                <div class="profile-main-container">
                    <div class="tab-container">
                        <button class="tab-btn active" onclick="showProfileTab('account')">Account Settings</button>
                        <button class="tab-btn" onclick="showProfileTab('password')">Change Password</button>
                    </div>
                    <div id="profile-tab-account" class="profile-tab active">
                        <div class="account-info">
                            <div class="avatar-section">
                                <div id="adminAvatarContainer" style="display:flex;align-items:center;justify-content:center;width:100px;height:100px;border-radius:50%;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;font-size:3rem;font-weight:bold;box-shadow:0 2px 12px 0 rgba(63,186,254,0.13);">P</div>
                            </div>
                            <div class="info-section">
                                <div><strong>Name:</strong> <span id="adminProfileName">Pratham Vernekar</span></div>
                                <div><strong>Email:</strong> <span id="adminProfileEmail">prathamvernekar05@gmail.com</span></div>
                            </div>
                        </div>
                    </div>
                    <div id="profile-tab-password" class="profile-tab" style="display:none;">
                        <form id="changePasswordForm" onsubmit="return handleChangePassword(event)">
                            <div class="form-group">
                                <label for="currentPassword">Current Password</label>
                                <input type="password" id="currentPassword" name="currentPassword" required>
                            </div>
                            <div class="form-group">
                                <label for="newPassword">New Password</label>
                                <input type="password" id="newPassword" name="newPassword" required>
                            </div>
                            <div class="form-group">
                                <label for="confirmPassword">Confirm New Password</label>
                                <input type="password" id="confirmPassword" name="confirmPassword" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Change Password</button>
                        </form>
                    </div>
                </div>
            </section>
            <!-- System Settings Panel -->
            <section id="system-settings-panel" class="admin-section" style="display:none;">
                <h1 class="dashboard-title">System Settings</h1>
                <div class="profile-main-container">
                    <div class="profile-cards-grid">
                        <div class="profile-card">
                            <div class="profile-card-title">AI Configuration</div>
                            <div class="form-group">
                                <label>AI Model</label>
                                <select class="form-control" id="aiModelSelect">
                                    <option value="default">Default (Ollama)</option>
                                    <option value="advanced">Advanced (GPT-3.5)</option>
                                    <option value="experimental">Experimental (GPT-4)</option>
                                </select>
                            </div>
                        </div>
                        <div class="profile-card">
                            <div class="profile-card-title">Feature Toggles</div>
                            <div class="form-group">
                                <label><input type="checkbox" id="speechToSpeechToggle" checked> Enable Speech-to-Speech</label>
                            </div>
                            <div class="form-group">
                                <label><input type="checkbox" id="textChatToggle" checked> Allow Text Chat</label>
                            </div>
                            <div class="form-group">
                                <label><input type="checkbox" id="feedbackToggle" checked> Enable User Feedback</label>
                            </div>
                            <div class="form-group">
                                <label><input type="checkbox" id="analyticsToggle" checked> Enable Analytics</label>
                            </div>
                            <div class="form-group">
                                <label><input type="checkbox" id="autoRefreshToggle" checked> Auto-refresh Dashboard</label>
                            </div>
                        </div>
                        <div class="profile-card">
                            <div class="profile-card-title">System Status</div>
                            <div class="system-section minimalist">
                              <h3>System Status</h3>
                              <p>Online</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>
    <div id="chatSessionModal" class="modal" style="display:none; position:fixed; z-index:2000; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); align-items:center; justify-content:center;">
  <div style="background:#23262f; color:#fff; border-radius:16px; max-width:600px; width:90vw; padding:32px; position:relative;">
    <button id="closeChatSessionModal" style="position:absolute; top:12px; right:16px; background:none; border:none; color:#fff; font-size:1.5rem; cursor:pointer;"><i class="fas fa-times"></i></button>
    <h2 id="modalSessionName">Session Details</h2>
    <div><strong>User:</strong> <span id="modalUserName"></span></div>
    <div><strong>Date:</strong> <span id="modalSessionDate"></span></div>
    <div style="margin-top:18px;"><strong>Messages:</strong></div>
    <div id="modalChatMessages" style="max-height:300px; overflow-y:auto; margin-top:8px; background:#181a20; border-radius:8px; padding:12px;"></div>
  </div>
</div>
<div id="chatActionsDropdownTemplate" style="display:none;">
  <div class="chat-actions-dropdown" style="position:absolute; background:#23262f; color:#fff; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.18); min-width:140px; z-index:3000;">
    <button class="dropdown-action-btn view-btn" style="width:100%; background:none; border:none; color:#fff; padding:10px 18px; text-align:left; cursor:pointer;"><i class="fas fa-eye"></i> View</button>
    <button class="dropdown-action-btn delete-btn" style="width:100%; background:none; border:none; color:#f87171; padding:10px 18px; text-align:left; cursor:pointer;"><i class="fas fa-trash"></i> Delete</button>
    <button class="dropdown-action-btn export-btn" style="width:100%; background:none; border:none; color:#3ffed2; padding:10px 18px; text-align:left; cursor:pointer;"><i class="fas fa-download"></i> Export</button>
  </div>
</div>
    <script src="script.js"></script>
    <script>
        // Dynamically set the avatar letter based on the real admin's name
        window.addEventListener('DOMContentLoaded', function() {
            var nameElem = document.getElementById('adminProfileName');
            var avatarElem = document.getElementById('adminAvatarContainer');
            if (nameElem && avatarElem) {
                var name = nameElem.textContent.trim();
                if (name.length > 0) {
                    avatarElem.textContent = name[0].toUpperCase();
                }
            }
        });
    </script>
    <!-- Add jsPDF and autoTable scripts for true table export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.7.0/jspdf.plugin.autotable.min.js"></script>
    <script>
async function exportAdminReportPDF() {
    // Ensure all data is loaded from the backend
    await window.loadAdminUsers(document.getElementById('usersTable'));
    await window.loadAdminChats(document.getElementById('chatsTable'));
    await window.loadAdminSuggestions();

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('landscape');
    let y = 20;
    // Cover Page
    doc.setFontSize(28);
    doc.setTextColor(44, 62, 80);
    doc.text('SkillSpeak AI', 14, y);
    doc.setFontSize(22);
    doc.text('Admin Detailed Report', 14, y + 14);
    doc.setFontSize(14);
    doc.setTextColor(100, 100, 100);
    doc.text('Generated: ' + new Date().toLocaleString(), 14, y + 26);
    doc.setTextColor(0,0,0);
    y += 40;
    doc.setFontSize(16);
    doc.text('Prepared for: Admin', 14, y);
    y += 10;
    doc.text('Organization: SkillSpeak AI', 14, y);
    y += 10;
    doc.text(' ', 14, y);
    doc.addPage();
    y = 20;
    // Dashboard Overview
    doc.setFontSize(20);
    doc.setTextColor(67, 90, 180);
    doc.text('Dashboard Overview', 14, y);
    y += 8;
    doc.setFontSize(12);
    doc.setTextColor(0,0,0);
    const stats = [];
    const totalUsers = document.getElementById('totalUsers')?.innerText || '-';
    const adminUsers = document.getElementById('adminUsers')?.innerText || '-';
    const totalChats = document.getElementById('totalChats')?.innerText || '-';
    const totalSuggestions = document.getElementById('totalSuggestFeedback')?.innerText || '-';
    stats.push(['Total Users', totalUsers]);
    stats.push(['Admin Users', adminUsers]);
    stats.push(['Total Chats', totalChats]);
    stats.push(['Total Suggestions', totalSuggestions]);
    doc.autoTable({
        head: [['Metric', 'Value']],
        body: stats,
        startY: y,
        theme: 'striped',
        headStyles: { fontStyle: 'bold', fillColor: [103, 126, 234], textColor: 255 },
        styles: { fontSize: 12, cellPadding: 3 }
    });
    y = doc.lastAutoTable.finalY + 10;
    doc.addPage();
    y = 20;
    // Chats List
    doc.setFontSize(20);
    doc.setTextColor(67, 90, 180);
    doc.text('Chats List', 14, y);
    y += 8;
    doc.setFontSize(12);
    doc.setTextColor(0,0,0);
    if (window.adminChats && window.adminChats.length) {
        const chatRows = window.adminChats.map(c => [
            c.session_name || '', c.user_name || '', c.date || '', c.chat_count || '', (c.messages ? c.messages.map(m => `${m.sender}: ${m.text}`).join('\n') : '')
        ]);
        doc.autoTable({
            head: [['Session Name', 'User Name', 'Date', 'Message Count', 'Messages']],
            body: chatRows,
            startY: y,
            theme: 'striped',
            headStyles: { fillColor: [103, 126, 234], textColor: 255 },
            styles: { cellWidth: 'wrap', fontSize: 10, cellPadding: 2 }
        });
        y = doc.lastAutoTable.finalY + 10;
    } else {
        doc.text('No chats found.', 14, y);
        y += 10;
    }
    doc.addPage();
    y = 20;
    // Users List
    doc.setFontSize(20);
    doc.setTextColor(67, 90, 180);
    doc.text('Users List', 14, y);
    y += 8;
    doc.setFontSize(12);
    doc.setTextColor(0,0,0);
    if (window.adminUsers && window.adminUsers.length) {
        const userRows = window.adminUsers.map(u => [
            u.name, u.email, u.role, u.status || '', u.created_at || '', u.last_login || ''
        ]);
        doc.autoTable({
            head: [['Name', 'Email', 'Role', 'Status', 'Created At', 'Last Login']],
            body: userRows,
            startY: y,
            theme: 'striped',
            headStyles: { fillColor: [103, 126, 234], textColor: 255 },
            styles: { fontSize: 10, cellPadding: 2 }
        });
        y = doc.lastAutoTable.finalY + 10;
    } else {
        doc.text('No users found.', 14, y);
        y += 10;
    }
    doc.addPage();
    y = 20;
    // Suggestions/Feedback List
    doc.setFontSize(20);
    doc.setTextColor(67, 90, 180);
    doc.text('Suggestions & Feedback List', 14, y);
    y += 8;
    doc.setFontSize(12);
    doc.setTextColor(0,0,0);
    if (window.adminSuggestions && window.adminSuggestions.length) {
        const suggestionRows = window.adminSuggestions.map(sg => [
            sg.user_name || sg.user_id || '', sg.suggestion || '', sg.status || '', sg.created_at || ''
        ]);
        doc.autoTable({
            head: [['User', 'Suggestion', 'Status', 'Date']],
            body: suggestionRows,
            startY: y,
            theme: 'striped',
            headStyles: { fillColor: [103, 126, 234], textColor: 255 },
            styles: { fontSize: 10, cellPadding: 2 }
        });
        y = doc.lastAutoTable.finalY + 10;
    } else {
        doc.text('No suggestions found.', 14, y);
        y += 10;
    }
    doc.addPage();
    y = 20;
    // Visual Graphs (week, month, year)
    doc.setFontSize(20);
    doc.setTextColor(67, 90, 180);
    doc.text('Visual Graphs', 14, y);
    y += 8;
    doc.setFontSize(12);
    doc.setTextColor(0,0,0);
    // Add User Growth Chart (week, month, year)
    const userGrowthModes = ['week', 'month', 'year'];
    userGrowthModes.forEach(mode => {
        const chartId = 'adminUserChart';
        const chartCanvas = document.getElementById(chartId);
        if (chartCanvas) {
            const chartImg = chartCanvas.toDataURL('image/png', 1.0);
            doc.setFontSize(12);
            doc.text(`User Growth (${mode})`, 14, y);
            doc.addImage(chartImg, 'PNG', 14, y + 2, 80, 32);
            y += 38;
        }
    });
    // Add User Streak Chart
    const streakChart = document.getElementById('userStreakChart');
    if (streakChart) {
        const streakImg = streakChart.toDataURL('image/png', 1.0);
        doc.setFontSize(12);
        doc.text('User Streaks', 14, y);
        doc.addImage(streakImg, 'PNG', 14, y + 2, 80, 32);
        y += 38;
    }
    // Footer with page numbers
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(10);
        doc.setTextColor(150, 150, 150);
        doc.text(`Page ${i} of ${pageCount}`, doc.internal.pageSize.getWidth() - 40, doc.internal.pageSize.getHeight() - 10);
    }
    doc.save('admin_detailed_report.pdf');
}
function exportUsersPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('landscape');
    doc.autoTable({ html: '#usersTable' });
    doc.save('users.pdf');
}
function exportChatsPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('landscape');
    doc.autoTable({ html: '#chatsTable' });
    doc.save('chats.pdf');
}
function exportSuggestionsPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('landscape');
    doc.autoTable({ html: '#suggestionTable' });
    doc.save('suggestions.pdf');
}
</script>
</body>
</html> 