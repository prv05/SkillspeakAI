<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SkillSpeak AI - Mentor Chat</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
    :root {
      --primary: #667eea;
      --secondary: #764ba2;
      --accent: #f093fb;
      --dark: #0a0a0a;
      --darker: #000000;
      --light: #ffffff;
      --gray: #1a1a1a;
      --light-gray: #2a2a2a;
      --text-light: #ffffff;
      --text-gray: #cccccc;
      --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-accent: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      --shadow-hover: 0 20px 40px rgba(0, 0, 0, 0.5);
      --bg-dark: #181a20;
      --bg-card: #23262f;
      --bg-sidebar: #1a1d23;
      --bg-topbar: #23262f;
      --text-main: #fff;
      --text-secondary: #a3a7b7;
      --primary-dark: #2b8ec6;
      --accent1: #8f3fe6;
      --accent2: #3ffed2;
      --border: #23262f;
      --radius: 16px;
    }
    html, body {
      height: 100vh;
      overflow: hidden;
    }
    body {
      background: var(--bg-dark);
      color: var(--text-main);
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
        .dashboard-container {
            display: flex;
            min-height: 100vh;
            background: var(--bg-dark);
            padding-top: 0;
            padding-bottom: 96px;
            box-sizing: border-box;
            margin-left: 240px;
        }
        .sidebar-modern {
    width: 240px;
    background: var(--bg-sidebar);
    display: flex;
    flex-direction: column;
    padding: 2rem 1rem 1rem 1rem;
    box-shadow: var(--shadow);
    height: 100vh;
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1100;
}
.sidebar-logo {
    font-size: 1.6rem;
    font-weight: bold;
    color: var(--primary);
    margin-bottom: 2rem;
    text-align: center;
    letter-spacing: 1px;
}
.sidebar-menu {
            width: 210px;
            list-style: none;
    padding: 0;
    margin: 0;
}
.sidebar-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.9rem 1.2rem;
    border-radius: var(--radius);
    color: var(--text-secondary);
    font-size: 1.08rem;
    margin-bottom: 0.3rem;
    cursor: pointer;
    transition: background 0.2s, color 0.2s;
}
.sidebar-item i {
    font-size: 1.2rem;
}
.sidebar-item.active, .sidebar-item:hover {
    background: var(--primary);
    color: #fff;
}
.sidebar-item.active i, .sidebar-item:hover i {
    color: #fff;
}
.sidebar-bottom {
    margin-top: 2rem;
    text-align: center;
}
.sidebar-darkmode {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 1rem;
    cursor: pointer;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    transition: background 0.2s;
}
.sidebar-darkmode:hover {
    background: var(--bg-card);
    color: var(--primary);
}
        .chat-layout {
            display: flex;
            flex: 1;
            margin-left: 10px;
            height: 100vh;
            background: var(--bg-dark);
            position: relative;
            transition: margin-right 0.3s cubic-bezier(.4,0,.2,1);
        }
        .chat-layout.history-open .history-sidebar {
            display: flex;
            right: 0;
        }
        .chat-layout.history-open .chat-card-container {
            margin-right: 340px;
            max-width: calc(100% - 340px);
            transition: max-width 0.3s, margin-right 0.3s;
        }
        .chat-main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-dark);
            align-items: center;
            justify-content: flex-start;
            min-height: 0;
            position: relative;
            height: 100%;
        }
        .chat-card-container {
            width: 100%;
            max-width: 1600px;
            min-height: 0;
            margin: auto;
            background: var(--bg-card);
            border-radius: var(--radius);
            box-shadow: 0 8px 32px 0 rgba(40,48,80,0.18);
            border: 1.5px solid #23262f;
            padding: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            justify-content: flex-end;
            height: 90%;
            transition: max-width 0.3s, margin-right 0.3s;
        }
        .chat-header {
            width: 100%;
            padding: 28px 36px 18px 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border-bottom: 1.5px solid #23262f;
        }
        .chat-header h2 {
            font-size: 1.7rem;
            font-weight: bold;
            margin: 0;
            color: var(--primary);
            letter-spacing: 0.5px;
            text-align: center;
        }
        .chat-header h2 + button {
            margin-left: 16px;
        }
        .chat-history {
            flex: 1;
            width: 100%;
            min-height: 0;
            max-height: none;
            overflow-y: auto;
            background: transparent;
            padding: 28px 36px;
            display: flex;
            flex-direction: column;
            gap: 18px;
            scrollbar-width: none; /* Firefox */
        }
        .chat-history::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        .chat-bubble {
            padding: 15px 22px;
            border-radius: 16px;
            max-width: 80%;
            font-size: 1.12rem;
            line-height: 1.7;
            word-break: break-word;
            box-shadow: 0 2px 10px rgba(0,0,0,0.10);
            margin-bottom: 6px;
        }
        .chat-bubble.user {
            background: linear-gradient(90deg, #66aaff 0%, #4263eb 100%);
            color: #fff;
            align-self: flex-end;
            border-bottom-right-radius: 8px;
        }
        .chat-bubble.ai {
            background: #232b36;
            color: #fff;
            align-self: flex-start;
            border-bottom-left-radius: 8px;
            border: 1px solid #2d323c;
        }
    /* History sidebar styles */
    .history-sidebar {
      position: fixed;
      top: 0;
      right: 0;
      width: 340px;
      height: 100vh;
      background: var(--bg-card, #23262f);
      box-shadow: -4px 0 24px rgba(40,48,80,0.18);
      z-index: 1000;
      display: none;
      flex-direction: column;
      transition: right 0.3s;
      border-top-left-radius: 24px;
      border-bottom-left-radius: 24px;
      overflow: hidden;
    }
    .chat-layout.history-open .history-sidebar {
      display: flex;
      right: 0;
    }
    .history-sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 2rem 1.5rem 1rem 1.5rem;
      background: var(--bg-sidebar);
      border-bottom: 1px solid var(--border);
    }
    .history-sidebar-title {
      font-size: 1rem;
      font-weight: 500;
      color: var(--primary, #667eea);
    }
    .history-sidebar-close {
      background: none;
      border: none;
      color: #fff;
      font-size: 1.3rem;
      cursor: pointer;
      border-radius: 50%;
      width: 36px;
      height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
      transition: background 0.18s;
    }
    .history-sidebar-close:hover {
      background: var(--primary, #667eea);
      color: #fff;
    }
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      padding: 0.5rem 0.5rem 0.5rem 0.5rem;
      margin-top: 0;
    }
    .history-item {
      background: var(--bg-dark, #181a20);
      border-radius: 8px;
      padding: 0.35rem 0.7rem 0.35rem 0.7rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: none;
      border: 1px solid var(--border);
      transition: background 0.15s, border 0.15s;
            position: relative;
      min-height: 32px;
      max-width: 100%;
    }
    .history-item:hover {
      background: var(--bg-card, #23262f);
      border: 1.5px solid var(--primary, #667eea);
    }
    .history-msg {
      color: #fff;
      font-size: 0.82rem;
      flex: 1;
      margin-right: 0.5rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 400;
      letter-spacing: 0.05px;
    }
    .history-delete-btn {
      background: none;
      border: none;
      color: #f87171;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 50%;
      width: 26px;
      height: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s, color 0.15s;
    }
    .history-delete-btn:hover {
      background: #2a2a2a;
      color: #fff;
    }
    /* Animation Overlay Styles */
    .animation-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #3a8dde 0%, #005bea 100%);
            display: none;
            align-items: center;
      justify-content: center;
      z-index: 900;
      transition: opacity 0.4s;
    }
    .animation-overlay.show {
            display: flex;
        }
    .soundwave {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      height: 80px;
    }
    .soundwave-bar {
      width: 12px;
      background: linear-gradient(180deg, #fff 0%, #3a8dde 100%);
      border-radius: 6px;
      animation: soundWaveBar 1.2s infinite;
    }
    .soundwave-bar:nth-child(1) { animation-delay: 0s; }
    .soundwave-bar:nth-child(2) { animation-delay: 0.2s; }
    .soundwave-bar:nth-child(3) { animation-delay: 0.4s; }
    .soundwave-bar:nth-child(4) { animation-delay: 0.6s; }
    .soundwave-bar:nth-child(5) { animation-delay: 0.8s; }
    @keyframes soundWaveBar {
      0%, 100% { height: 20px; opacity: 0.7; }
      50% { height: 80px; opacity: 1; }
    }
    /* Bottom Bar Layout */
    .bottom-bar {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 36px 18px 36px;
      background: var(--bg-sidebar, #181b20);
      border-top: 1.5px solid #262b36;
      position: fixed;
      left: 0;
      bottom: 0;
      min-height: 80px;
      z-index: 100;
      border-radius: 0;
    }
    .bottom-bar .left-controls, .bottom-bar .right-controls {
            display: flex;
            align-items: center;
      gap: 18px;
    }
    .bottom-bar .center-controls {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
    }
    .toggle-animation-btn {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, #3a8dde 0%, #005bea 100%);
            color: #fff;
      border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
      margin: 0 24px;
      box-shadow: 0 4px 16px rgba(58, 141, 222, 0.25);
      position: relative;
      transition: background 0.25s, box-shadow 0.25s;
    }
    .toggle-animation-btn.active {
      background: #232b36;
      color: #3a8dde;
    }
    .big-mic-btn {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .big-mic-btn .mic-soundbars {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      gap: 4px;
      z-index: 0;
      pointer-events: none;
    }
    .big-mic-btn .mic-soundbar {
      width: 4px;
      height: 18px;
      background: linear-gradient(180deg, #fff 0%, #3a8dde 100%);
      border-radius: 2px;
      opacity: 0.7;
      animation: micSoundBar 1s infinite;
    }
    .big-mic-btn .mic-soundbar:nth-child(1) { animation-delay: 0s; }
    .big-mic-btn .mic-soundbar:nth-child(2) { animation-delay: 0.2s; }
    .big-mic-btn .mic-soundbar:nth-child(3) { animation-delay: 0.4s; }
    .big-mic-btn .mic-soundbar:nth-child(4) { animation-delay: 0.6s; }
    .big-mic-btn .mic-soundbar:nth-child(5) { animation-delay: 0.8s; }
    @keyframes micSoundBar {
      0%, 100% { height: 18px; opacity: 0.7; }
      50% { height: 36px; opacity: 1; }
    }
        .big-mic-btn button {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, #3a8dde 0%, #005bea 100%);
            color: #fff;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
      transition: background 0.25s, box-shadow 0.25s, transform 0.18s;
      box-shadow: 0 4px 16px rgba(58, 141, 222, 0.25);
      position: relative;
      outline: none;
      z-index: 1;
    }
        .big-mic-btn button:hover {
      background: linear-gradient(135deg, #005bea 0%, #3a8dde 100%);
      transform: scale(1.07);
      box-shadow: 0 8px 24px rgba(58, 141, 222, 0.35);
    }
        .big-mic-btn button:active {
      background: #005bea;
      transform: scale(0.97);
    }
    .big-mic-btn button i {
      position: relative;
      z-index: 1;
    }
    .mic-ripple {
            position: absolute;
      top: 50%;
      left: 50%;
      width: 56px;
      height: 56px;
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: 0;
    }
    .mic-ripple span {
            position: absolute;
      top: 50%;
      left: 50%;
      width: 56px;
      height: 56px;
            border-radius: 50%;
      border: 2px solid #3a8dde;
      transform: translate(-50%, -50%) scale(1);
      opacity: 0.7;
      animation: micRipple 1.2s infinite;
    }
    .mic-ripple span:nth-child(2) {
      animation-delay: 0.4s;
      opacity: 0.5;
    }
    .mic-ripple span:nth-child(3) {
      animation-delay: 0.8s;
      opacity: 0.3;
    }
    @keyframes micRipple {
      0% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 0.7;
      }
      80% {
        opacity: 0.1;
            }
            100% {
        transform: translate(-50%, -50%) scale(2.2);
                opacity: 0;
            }
        }
    .attach-btn, .text-voice-btn, .history-icon-btn {
      width: 44px;
      height: 44px;
      background: #232b36;
      color: #3a8dde;
      border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
      transition: background 0.2s;
    }
    .attach-btn:active, .text-voice-btn:active, .history-icon-btn:active {
      background: #1a2230;
    }
    .history-icon-btn {
      background: var(--primary, #3a8dde);
      color: #fff;
      font-size: 1.5rem;
      margin-left: 12px;
      box-shadow: 0 2px 8px rgba(40,48,80,0.12);
    }
    .history-icon-btn:hover {
      background: var(--primary-dark, #005bea);
    }
    .history-icon-btn.top-right {
      position: absolute;
      top: 18px;
      right: 24px;
      z-index: 20;
      background: var(--primary, #3a8dde);
      color: #fff;
      font-size: 1.5rem;
      box-shadow: 0 2px 8px rgba(40,48,80,0.12);
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .history-icon-btn.top-right:hover {
      background: var(--primary-dark, #005bea);
    }
    .send-btn:hover {
      background: var(--primary-dark, #2b8ec6);
    }
    @media (max-width: 1100px) {
      .history-sidebar {
        width: 90vw;
        right: 0;
      }
      .chat-layout.history-open .chat-card-container {
        margin-right: 0;
        max-width: 100%;
      }
      .bottom-bar {
        left: 0;
        bottom: 0;
        border-radius: 0;
      }
    }
    #chatInput::-webkit-scrollbar {
      display: none;
    }
    #chatInput {
      scrollbar-width: none;
    }
    .new-chat-btn {
      background: var(--primary, #667eea);
            color: #fff;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      margin-left: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      transition: background 0.18s;
    }
    .new-chat-btn:hover {
      background: var(--primary-dark, #2b8ec6);
        }
    .top-navbar {
      width: 100%;
      height: 64px;
      background: var(--bg-card, #23262f);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 36px;
      box-shadow: 0 2px 8px rgba(40,48,80,0.08);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
    }
    .nav-title {
      position: absolute;
      left: 0;
      right: 0;
      margin: auto;
      text-align: center;
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--primary, #667eea);
      letter-spacing: 1px;
      pointer-events: none;
    }
    .nav-actions {
      position: absolute;
      right: 36px;
      top: 0;
      height: 100%;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .nav-profile-pic {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      margin-left: 10px;
      border: 2px solid var(--primary, #667eea);
      box-shadow: 0 2px 8px rgba(40,48,80,0.10);
        }
    .start-interview-container {
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 32px 0;
    }
    .start-interview-container .btn {
      font-size: 1.3rem;
      padding: 18px 48px;
      border-radius: 32px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .start-interview-container .btn:hover {
      background: var(--primary-dark, #2b8ec6);
    }
    .start-interview-container .btn:active {
      background: #005bea;
    }
    .start-interview-container .btn i {
      font-size: 1.8rem;
    }
    .mic-wave {
      display: inline-block;
      width: 60px;
      height: 24px;
      vertical-align: middle;
    }
    .wave-bar {
      display: inline-block;
      width: 8px;
      height: 100%;
      background: var(--primary);
      margin: 0 2px;
      border-radius: 4px;
      animation: wave 1s infinite alternate;
    }
    @keyframes wave {
      0% { height: 40%; }
      100% { height: 100%; }
    }
    #voiceErrorMsg {
      color: #ff4d4f;
      background: #23262f;
      border: 1px solid #ff4d4f;
      border-radius: 8px;
      padding: 10px 18px;
      margin: 12px auto;
      max-width: 500px;
      text-align: center;
      display: none;
      font-size: 1.08rem;
    }
    #fallbackTextInput {
      display: none;
      margin: 16px auto;
      max-width: 500px;
      width: 100%;
      padding: 10px 16px;
      border-radius: 8px;
      border: 1px solid #23262f;
      font-size: 1.1rem;
      background: #181a20;
      color: #fff;
    }
    #retryMicBtn {
      display: none;
      margin: 8px auto 0 auto;
      background: #667eea;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 18px;
      font-size: 1rem;
      cursor: pointer;
    }
    #retryMicBtn:hover {
      background: #2b8ec6;
    }
    .topbar-user-info {
      position: absolute;
      top: 32px;
      right: 48px;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      padding: 8px 24px 8px 16px;
      border-radius: 50%;
      border: 3px solid transparent;
      transition: border 0.2s, box-shadow 0.2s, background 0.2s;
      min-height: 54px;
      min-width: 54px;
      background: none;
    }
    .topbar-user-info:hover {
      border: 3px soild  ;
      border-radius: 25 px ;
      border-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-image-slice: 1;
      box-shadow: none;
      background: none;
    }
    /* No hover effect on user info */
    .topbar-user-info #userAvatarContainer {
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      background: none;
    }
    .topbar-user-info .user-name {
      font-size: 1.15rem;
      font-weight: 500;
      color: var(--text-secondary);
      margin-left: 6px;
    }
    .mic-animation-overlay {
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }
    .mic-wave-container {
      position: relative;
      width: 120px;
      height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .mic-icon-bg {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 50%;
      width: 64px;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 24px 0 rgba(63,186,254,0.18);
      z-index: 2;
    }
    .mic-icon-bg i {
      color: #fff;
      font-size: 2.2rem;
    }
    .mic-waves {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      z-index: 1;
    }
    .mic-wave-circle {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 3px solid #667eea;
      opacity: 0.5;
      transform: translate(-50%, -50%) scale(1);
      animation: micWave 1.6s infinite cubic-bezier(0.4,0,0.2,1);
    }
    .mic-wave-circle:nth-child(2) {
      animation-delay: 0.5s;
      border-color: #764ba2;
    }
    .mic-wave-circle:nth-child(3) {
      animation-delay: 1s;
      border-color: #f093fb;
    }
    @keyframes micWave {
      0% {
        opacity: 0.5;
        transform: translate(-50%, -50%) scale(1);
      }
      70% {
        opacity: 0.15;
        transform: translate(-50%, -50%) scale(1.7);
      }
      100% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(2.1);
      }
    }
</style>
</head>
<body class="dark">
    <div class="dashboard-container">
        <!-- Left Navigation Sidebar -->
        <aside class="sidebar-modern">
            <div class="sidebar-logo">SkillSpeak</div>
            <ul class="sidebar-menu" style="width:210px;">
                <li class="sidebar-item" onclick="window.location.href='dashboard.html'"><i class="fas fa-chart-pie"></i> <span>Dashboard</span></li>
                <li class="sidebar-item active"><i class="fas fa-comments"></i> <span>Chat</span></li>
                <li class="sidebar-item" onclick="window.location.href='profile.html'"><i class="fas fa-book"></i> <span>Profile</span></li>
                <li class="sidebar-item" onclick="window.location.href='feedback.html'"><i class="fas fa-comment-dots"></i> <span>Feedback</span></li>
                <li class="sidebar-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></li>
            </ul>
        </aside>
        <div class="chat-layout" id="chatLayout">
            <!-- Main Chat Area -->
            <div class="chat-main-area" style="position:relative;">
              <div style="width: 100%; text-align: center; margin-top: 32px; margin-bottom: 8px;">
                <span style="font-size: 2rem; font-weight: bold; color: var(--primary, #667eea); letter-spacing: 1px;">AI Mentor</span>
              </div>
              <!-- Replace the user info section at the top of chat page with the following -->
<div class="user-info" onclick="window.location.href='profile.html'" style="cursor: pointer; position: absolute; top: 24px; right: 32px; z-index: 10; display: flex; align-items: center; gap: 0.5rem;">
  <span id="userAvatarContainer">
    <i class="fas fa-user-circle" style="font-size:2rem;"></i>
  </span>
  <span class="user-name" id="userName">Guest</span>
</div>
        <div class="chat-card-container" id="chatCardContainer" style="margin: 0 auto 16px auto; max-width: 1200px; min-width: 340px; min-height: 500px; box-shadow: 0 8px 32px 0 rgba(40,48,80,0.18); border-radius: 24px; background: var(--bg-card, #23262f); position: relative; display: flex; flex-direction: column;">
          <div style="height: 64px; border-bottom: 1.5px solid #23262f;"></div>
                    <!-- Removed duplicate centered AI Mentor heading -->
                    <div class="chat-history" id="chatHistory">
                      <div class="chat-bubble ai" id="aiWelcomeMsg"></div>
                    </div>
        </div>
        <!-- Animation overlay for soundwave -->
        <div class="animation-overlay" id="animationOverlay">
          <div class="soundwave">
            <div class="soundwave-bar"></div>
            <div class="soundwave-bar"></div>
            <div class="soundwave-bar"></div>
            <div class="soundwave-bar"></div>
            <div class="soundwave-bar"></div>
          </div>
        </div>
        <!-- Place the mic animation overlay just above the Start Interview button -->
        <div style="width:100%;display:flex;justify-content:center;align-items:center;flex-direction:column;">
          <div class="mic-animation-overlay" id="micAnimationOverlay" style="display:none;position:relative;width:auto;height:auto;z-index:2000;align-items:center;justify-content:center;pointer-events:none;margin-bottom:16px;">
            <div class="mic-wave-container">
              <div class="mic-waves">
                <span class="mic-wave-circle"></span>
                <span class="mic-wave-circle"></span>
                <span class="mic-wave-circle"></span>
              </div>
              <span class="mic-icon-bg">
                <i class="fas fa-microphone"></i>
              </span>
            </div>
          </div>
          <!-- Start Interview Button -->
          <button id="startInterviewBtn" class="btn btn-secondary" style="font-size:1.3rem;padding:18px 48px;border-radius:32px;display:flex;align-items:center;gap:16px;margin-top:24px;">
            <i class="fas fa-microphone"></i> Start Interview
          </button>
        </div>
    </div>
    <script src="script.js"></script>
    <script>
        // Add browser TTS function at the top so it's available everywhere
        function speakText(text) {
          return new Promise((resolve) => {
            if ('speechSynthesis' in window) {
              const utterance = new SpeechSynthesisUtterance(text);
              utterance.onend = resolve;
              window.speechSynthesis.speak(utterance);
            } else {
              resolve();
            }
          });
        }
        // Load user info when page loads
        
        // Remove localStorage usage for chat history, replace with API calls

        function loadUserInfo() {
          const userName = localStorage.getItem("userName") || "Guest";
          document.getElementById("userName").innerText = userName;
          // Show avatar with first letter of user name
          const firstLetter = userName.charAt(0).toUpperCase();
          document.getElementById("userAvatarContainer").innerHTML = `<span style="display:inline-flex;align-items:center;justify-content:center;width:2.2rem;height:2.2rem;border-radius:50%;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;font-size:1.2rem;font-weight:bold;">${firstLetter}</span>`;
        }
        document.addEventListener('DOMContentLoaded', loadUserInfo);

        let currentSessionId = localStorage.getItem('currentSessionId') || null;

        function startNewSession() {
          currentSessionId = null;
          localStorage.removeItem('currentSessionId');
        }

        // Remove the custom logout() function from this file

    document.addEventListener('DOMContentLoaded', function() {
      const chatLayout = document.getElementById('chatLayout');
      const historyIconBtn = document.getElementById('historyIconBtn');
      const animationOverlay = document.getElementById('animationOverlay');
      const bigMicBtn = document.getElementById('bigMicBtn');
      let isListening = false;
      // History sidebar toggle
      if (historyIconBtn && chatLayout) {
        historyIconBtn.addEventListener('click', function() {
          chatLayout.classList.toggle('history-open');
        });
      }
      // Mic button listening effect
      if (bigMicBtn) {
        bigMicBtn.addEventListener('click', function() {
          if (!isListening) {
            isListening = true;
            bigMicBtn.classList.add('listening');
            // Add ripple effect if not present
            if (!bigMicBtn.querySelector('.mic-ripple')) {
              const ripple = document.createElement('div');
              ripple.className = 'mic-ripple';
              ripple.innerHTML = '<span></span><span></span><span></span>';
              bigMicBtn.insertBefore(ripple, bigMicBtn.firstChild);
            }
            bigMicBtn.title = 'Stop Recording';
          } else {
            isListening = false;
            bigMicBtn.classList.remove('listening');
            // Remove ripple effect
            const ripple = bigMicBtn.querySelector('.mic-ripple');
            if (ripple) ripple.remove();
            bigMicBtn.title = 'Talk to AI';
          }
        });
      }
      // Attach button logic
      const attachBtn = document.getElementById('attachBtn');
      const fileInput = document.getElementById('fileInput');
      const filePreview = document.getElementById('filePreview');
      if (attachBtn && fileInput) {
        attachBtn.addEventListener('click', function() {
          fileInput.value = '';
          fileInput.click();
        });
      }
      if (fileInput && filePreview) {
        fileInput.addEventListener('change', function(e) {
          if (fileInput.files && fileInput.files.length > 0) {
            const file = fileInput.files[0];
            filePreview.textContent = 'Attached: ' + file.name;
            filePreview.style.display = 'block';
          } else {
            filePreview.textContent = '';
            filePreview.style.display = 'none';
          }
        });
      }
      // Voice/Text toggle logic
      const textInputGroup = document.getElementById('textInputGroup');
      const voiceGroup = document.getElementById('voiceGroup');
      const textVoiceBtn = document.getElementById('textVoiceBtn');
      const textVoiceBtnVoice = document.getElementById('textVoiceBtnVoice');
      const modeIndicator = document.getElementById('modeIndicator');
      if (textVoiceBtn && textInputGroup && voiceGroup) {
        textVoiceBtn.addEventListener('click', function() {
          textInputGroup.style.display = 'none';
          voiceGroup.style.display = 'flex';
        });
      }
      if (textVoiceBtnVoice && textInputGroup && voiceGroup) {
        textVoiceBtnVoice.addEventListener('click', function() {
          textInputGroup.style.display = 'flex';
          voiceGroup.style.display = 'none';
        });
      }
      // Rotating placeholder logic
      const placeholders = [
        'Ask your mentor...',
        'Take up an interview...',
        'See the latest questions...'
      ];
      let phIndex = 0;
      const chatInput = document.getElementById('chatInput');
      if (chatInput) {
        setInterval(() => {
          phIndex = (phIndex + 1) % placeholders.length;
          if (chatInput.value.trim() === '') {
            chatInput.placeholder = placeholders[phIndex];
          }
        }, 2000);
      }
      // Text input send on Enter
      const chatHistory = document.getElementById('chatHistory');
      if (chatInput && chatHistory) {
        chatInput.addEventListener('keydown', function(e) {
          // Enter to send, Shift+Enter for newline
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            const msg = chatInput.value.trim();
            if (msg.length > 0) {
              sendMessage(msg);
            }
          } else {
            // Auto-grow textarea
            setTimeout(() => {
              chatInput.style.height = 'auto';
              chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
            }, 0);
          }
        });
      }
      // Send button logic
      const sendBtn = document.getElementById('sendBtn');
      if (sendBtn) {
        sendBtn.addEventListener('click', function() {
          const msg = chatInput.value.trim();
          if (msg.length > 0) {
            sendMessage(msg);
          }
        });
      }
      // Username logic for welcome message
      // Instead of asking for username, use logged-in user or default
      let username = null;
      // Try to get user from localStorage or global user object
      if (window.currentUser && window.currentUser.name) {
        username = window.currentUser.name;
      } else if (localStorage.getItem('ssai_user_name')) {
        username = localStorage.getItem('ssai_user_name');
      }
      function setWelcomeMsg(name) {
        const aiWelcomeMsg = document.getElementById('aiWelcomeMsg');
        if (aiWelcomeMsg) {
          aiWelcomeMsg.textContent = `Hi! I am your AI mentor. How can I help you today${name ? ', ' + name : ''}?`;
        }
      }
      setWelcomeMsg(username);
        });

        async function sendMessage(msg) {
            const chatHistory = document.getElementById('chatHistory');
            const aiWelcomeMsg = document.getElementById('aiWelcomeMsg');
            const animationOverlay = document.getElementById('animationOverlay');
            const userAvatarContainer = document.getElementById('userAvatarContainer');
            const userName = document.getElementById('userName').innerText;

            // Add user message to chat history
            const userBubble = document.createElement('div');
            userBubble.className = 'chat-bubble user';
            userBubble.textContent = msg;
            if (chatHistory) {
              chatHistory.appendChild(userBubble);
              chatHistory.scrollTop = chatHistory.scrollHeight;
            }

            // Show animation overlay
            if (animationOverlay) {
              animationOverlay.classList.add('show');
            }

            // Clear previous welcome message if it exists
            if (aiWelcomeMsg && aiWelcomeMsg.textContent.includes('How can I help you today')) {
                aiWelcomeMsg.textContent = '';
            }

            try {
                const userId = localStorage.getItem('userName');
                // If this is the first message in a session, treat it as the job role
                if (!currentSessionId) {
                    currentSessionId = msg; // Use job role as session_id
                    localStorage.setItem('currentSessionId', currentSessionId);
                }
                // Send chat message to the correct endpoint for storage
                const res = await fetch('http://localhost:5000/api/voice/chat/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        role: 'user',
                        message: msg,
                        session_id: currentSessionId
                    })
                });

                // Add AI response to chat history
                const aiBubble = document.createElement('div');
                aiBubble.className = 'chat-bubble ai';
                aiBubble.textContent = res.message;
                if (chatHistory) {
                  chatHistory.appendChild(aiBubble);
                  chatHistory.scrollTop = chatHistory.scrollHeight;
                }

                // Hide animation overlay
                if (animationOverlay) {
                  animationOverlay.classList.remove('show');
                }

                // Update user avatar
                if (userAvatarContainer) {
                  userAvatarContainer.innerHTML = `<img src="${res.user.avatar || 'assets/default-avatar.png'}" alt="User Avatar" style="width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--primary, #667eea); box-shadow: 0 2px 8px rgba(40,48,80,0.10);">`;
                }

            } catch (err) {
                alert('Failed to send message to AI');
                console.error(err);
                // Hide animation overlay on error
                if (animationOverlay) {
                  animationOverlay.classList.remove('show');
                }
            }
        }
    // Interview button and mic/wave effect
    const startInterviewBtn = document.getElementById('startInterviewBtn');
    const micWaveEffect = document.getElementById('micWaveEffect');
    const chatHistory = document.getElementById('chatHistory');

    // Web Speech API setup
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    let recognitionActive = false;
    if (SpeechRecognition) {
      recognition = new SpeechRecognition();
      recognition.lang = 'en-US';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
    }

    // Voice error/fallback UI elements
    const voiceErrorMsg = document.getElementById('voiceErrorMsg');
    const fallbackTextInput = document.getElementById('fallbackTextInput');
    const retryMicBtn = document.getElementById('retryMicBtn');

    function showVoiceError(msg, showRetry = true, showFallback = true) {
      if (voiceErrorMsg) {
        voiceErrorMsg.textContent = msg;
        voiceErrorMsg.style.display = 'block';
      }
      if (retryMicBtn) {
        retryMicBtn.style.display = showRetry ? 'block' : 'none';
      }
      if (fallbackTextInput) {
        fallbackTextInput.style.display = showFallback ? 'block' : 'none';
      }
    }
    function hideVoiceError() {
      if (voiceErrorMsg) {
        voiceErrorMsg.style.display = 'none';
      }
      if (retryMicBtn) {
        retryMicBtn.style.display = 'none';
      }
      if (fallbackTextInput) {
        fallbackTextInput.style.display = 'none';
      }
    }
    if (retryMicBtn) {
      retryMicBtn.onclick = () => {
        hideVoiceError();
        window.location.reload(); // Easiest way to re-request mic permission
      };
    }

    async function getVoiceInput(promptText, timeout = 15000) { // Added timeout parameter
      return new Promise((resolve) => {
        if (!recognition) {
          showVoiceError('Speech recognition is not supported in this browser. Please use Chrome or type your answer below.', false, true);
          if (fallbackTextInput) {
            fallbackTextInput.value = '';
            fallbackTextInput.onkeydown = function(e) {
              if (e.key === 'Enter') {
                hideVoiceError();
                resolve(fallbackTextInput.value.trim());
              }
            };
            fallbackTextInput.style.display = 'block';
            fallbackTextInput.focus();
          }
          return;
        }
        let transcript = '';
        let startTime = Date.now();
        let minDuration = timeout; // Use the provided timeout
        let ended = false;
        let micTimeout;
        function startRec() {
          if (!recognitionActive) {
            recognition.start();
          }
        }
        function stopRec() {
          try { recognition.stop(); } catch (e) {}
        }
        recognition.onstart = function() {
          recognitionActive = true;
        };
        recognition.onend = function() {
          recognitionActive = false;
          if (ended) return;
          if ((Date.now() - startTime) < minDuration) {
            setTimeout(() => {
              if (!recognitionActive && !ended) startRec();
            }, 100);
          } else {
            ended = true;
            stopRec();
            if (!transcript) {
              showVoiceError('No voice input detected. Please check your microphone or type your answer below.', true, true);
              if (fallbackTextInput) {
                fallbackTextInput.value = '';
                fallbackTextInput.onkeydown = function(e) {
                  if (e.key === 'Enter') {
                    hideVoiceError();
                    resolve(fallbackTextInput.value.trim());
                  }
                };
                fallbackTextInput.style.display = 'block';
                fallbackTextInput.focus();
              }
            } else {
              hideVoiceError();
              resolve(transcript);
            }
          }
        };
        recognition.onresult = function(event) {
          transcript = event.results[0][0].transcript;
          ended = true;
          stopRec();
          hideVoiceError();
          resolve(transcript);
        };
        recognition.onerror = function(event) {
          recognitionActive = false;
          showVoiceError('Microphone error or permission denied. Please allow microphone access, retry, or type your answer below.', true, true);
          if (fallbackTextInput) {
            fallbackTextInput.value = '';
            fallbackTextInput.onkeydown = function(e) {
              if (e.key === 'Enter') {
                hideVoiceError();
                resolve(fallbackTextInput.value.trim());
              }
            };
            fallbackTextInput.style.display = 'block';
            fallbackTextInput.focus();
          }
        };
        startRec();
        // Failsafe: after timeout, force stop and resolve if not already
        micTimeout = setTimeout(() => {
          if (!ended) {
            ended = true;
            stopRec();
            if (!transcript) {
              showVoiceError('No voice input detected. Please check your microphone or type your answer below.', true, true);
              if (fallbackTextInput) {
                fallbackTextInput.value = '';
                fallbackTextInput.onkeydown = function(e) {
                  if (e.key === 'Enter') {
                    hideVoiceError();
                    resolve(fallbackTextInput.value.trim());
                  }
                };
                fallbackTextInput.style.display = 'block';
                fallbackTextInput.focus();
              }
            } else {
              hideVoiceError();
              resolve(transcript || '');
            }
          }
        }, minDuration + 500);
      });
    }

    // Utility to disable/enable input
    function setInputEnabled(enabled) {
      if (fallbackTextInput) {
        fallbackTextInput.disabled = !enabled;
        if (enabled) {
          fallbackTextInput.style.opacity = '1';
        } else {
          fallbackTextInput.style.opacity = '0.5';
        }
      }
    }

    async function createNewSession() {
      const userId = localStorage.getItem('userName') || 'anonymous';
      const sessionId = 'session_' + Date.now();
      const sessionName = 'Interview Session';
      const startTime = new Date().toISOString();
      const sessionData = {
        session_id: sessionId,
        user_id: userId,
        session_name: sessionName,
        start_time: startTime,
        chats: []
      };
      try {
        await fetch('http://localhost:5000/api/session/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(sessionData)
        });
        localStorage.setItem('currentSessionId', sessionId);
        localStorage.setItem('sessionStartTime', startTime); // Store start time for later
        return sessionId;
      } catch (err) {
        alert('Failed to create session. Please try again.');
        throw err;
      }
    }

    async function runBrowserInterview(sessionId) {
      if (startInterviewBtn) {
        startInterviewBtn.disabled = true;
        startInterviewBtn.style.display = 'none';
      }
      showMicAnimation(true); // Show mic animation
      if (chatHistory) {
        chatHistory.innerHTML = '';
      }
      let answers = [];
      let role = '';
      let sessionMessages = [];
      // Use the provided sessionId
      // Step 0: Get welcome prompt from backend
      let stepRes, stepData;
      try {
        stepRes = await fetch('http://127.0.0.1:5000/api/voice/interview/step', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ role: '', answers: [] })
        });
        stepData = await stepRes.json();
        console.log('Step 0 response:', stepData);
      } catch (err) {
        const errorBubble = document.createElement('div');
        errorBubble.className = 'chat-bubble ai';
        errorBubble.textContent = 'Error: Could not start interview.';
        if (chatHistory) {
          chatHistory.appendChild(errorBubble);
        }
        showMicAnimation(false); // Hide mic animation
        if (startInterviewBtn) {
          startInterviewBtn.disabled = false;
          startInterviewBtn.style.display = 'inline-flex';
        }
        return;
      }
      // Show welcome prompt or error
      if (!stepData || !stepData.prompt) {
        const errorBubble = document.createElement('div');
        errorBubble.className = 'chat-bubble ai';
        errorBubble.textContent = 'Error: No prompt received from backend.';
        if (chatHistory) {
          chatHistory.appendChild(errorBubble);
        }
        showMicAnimation(false); // Hide mic animation
        if (startInterviewBtn) {
          startInterviewBtn.disabled = false;
          startInterviewBtn.style.display = 'inline-flex';
        }
        return;
      }
      let welcomePrompt = stepData.prompt;
      if (welcomePrompt && welcomePrompt.toLowerCase().includes('ai interviewer')) {
        let username = null;
        if (window.currentUser && window.currentUser.name) {
          username = window.currentUser.name;
        } else if (localStorage.getItem('ssai_user_name')) {
          username = localStorage.getItem('ssai_user_name');
        } else if (localStorage.getItem('userName')) {
          username = localStorage.getItem('userName');
        }
        if (username) {
          welcomePrompt = `Welcome to SkillSpeak AI, ${username}. Please tell me your job role.`;
        } else {
          welcomePrompt = 'Welcome to SkillSpeak AI. Please tell me your job role.';
        }
      }
      const welcomeBubble = document.createElement('div');
      welcomeBubble.className = 'chat-bubble ai';
      welcomeBubble.textContent = welcomePrompt;
      if (chatHistory) {
        chatHistory.appendChild(welcomeBubble);
        chatHistory.scrollTop = chatHistory.scrollHeight;
      }
      sessionMessages.push({role: 'ai', message: welcomePrompt});
      await speakText(welcomePrompt);
      // Get role from user
      role = await getVoiceInput('Speak your role...');
      const roleBubble = document.createElement('div');
      roleBubble.className = 'chat-bubble user';
      roleBubble.textContent = role;
      if (chatHistory) {
        chatHistory.appendChild(roleBubble);
        chatHistory.scrollTop = chatHistory.scrollHeight;
      }
      sessionMessages.push({role: 'user', message: role});
      if (!role) {
        showMicAnimation(false); // Hide mic animation
        if (startInterviewBtn) {
          startInterviewBtn.disabled = false;
          startInterviewBtn.style.display = 'inline-flex';
        }
        setTimeout(() => { alert('No role provided. Interview cancelled.'); }, 100);
        return;
      }
      answers.push(role);
      // 1. Always ask "Please introduce yourself." after job role
      const introduceBubble = document.createElement('div');
      introduceBubble.className = 'chat-bubble ai';
      introduceBubble.textContent = 'Please introduce yourself.';
      if (chatHistory) {
        chatHistory.appendChild(introduceBubble);
        chatHistory.scrollTop = chatHistory.scrollHeight;
      }
      sessionMessages.push({role: 'ai', message: 'Please introduce yourself.'});
      setInputEnabled(false);
      await speakText('Please introduce yourself.');
      await new Promise(resolve => setTimeout(resolve, 1000)); // Short pause
      await speakText('Now, please answer.');
      showMicAnimation(true); // Show mic animation and start recording
      const answer = await getVoiceInput('Speak your answer...', 20000); // 20 seconds
      showMicAnimation(false); // Hide mic animation after answer or timeout
      console.log('Recognized answer:', answer);
      if (!answer) {
        const warnBubble = document.createElement('div');
        warnBubble.className = 'chat-bubble ai';
        warnBubble.style.color = 'orange';
        warnBubble.textContent = 'No voice input detected. Please try again or check your microphone.';
        if (chatHistory) {
          chatHistory.appendChild(warnBubble);
          chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        await speakText('No voice input detected. Please try again or check your microphone.');
      }
      answers.push(answer);
      const introBubble = document.createElement('div');
      introBubble.className = 'chat-bubble user';
      introBubble.textContent = answer;
      if (chatHistory) {
        chatHistory.appendChild(introBubble);
        chatHistory.scrollTop = chatHistory.scrollHeight;
      }
      sessionMessages.push({role: 'user', message: answer});
      // Stepwise Q&A (dynamic)
      let keepGoing = true;
      while (keepGoing) {
        // Get next question or feedback from backend
        stepRes = await fetch('http://127.0.0.1:5000/api/voice/interview/step', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ role, answers })
        });
        stepData = await stepRes.json();
        console.log('Backend question/feedback response:', stepData);
        if (stepData.type === 'feedback') {
          // Show feedbacks
          if (stepData.feedbacks && stepData.feedbacks.length) {
            for (let i = 0; i < stepData.feedbacks.length; i++) {
              const fBubble = document.createElement('div');
              fBubble.className = 'chat-bubble ai';
              fBubble.textContent = 'Feedback: ' + stepData.feedbacks[i] + ' (Score: ' + stepData.scores[i] + '/10)';
              if (chatHistory) {
                chatHistory.appendChild(fBubble);
                chatHistory.scrollTop = chatHistory.scrollHeight;
              }
              sessionMessages.push({role: 'ai', message: 'Feedback: ' + stepData.feedbacks[i] + ' (Score: ' + stepData.scores[i] + '/10)'});
              await speakText('Feedback: ' + stepData.feedbacks[i] + ' (Score: ' + stepData.scores[i] + '/10)');
            }
          }
          // Show summary
          if (stepData.summary) {
            const summaryBubble = document.createElement('div');
            summaryBubble.className = 'chat-bubble ai';
            summaryBubble.textContent = 'Summary: ' + stepData.summary;
            if (chatHistory) {
              chatHistory.appendChild(summaryBubble);
              chatHistory.scrollTop = chatHistory.scrollHeight;
            }
            sessionMessages.push({role: 'ai', message: 'Summary: ' + stepData.summary});
            await speakText('Summary: ' + stepData.summary);
          }
          // Save to backend for history
          if (window.saveChatSession) {
            await window.saveChatSession(sessionMessages, stepData.summary || '', sessionId);
          }
          localStorage.setItem('ai_feedback', JSON.stringify(stepData.feedbacks));
          localStorage.setItem('ai_summary', stepData.summary);
          const userId = localStorage.getItem('userName') || 'anonymous';
          await fetch('http://127.0.0.1:5000/api/feedback/ai_feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              user_id: userId,
              feedbacks: stepData.feedbacks,
              summary: stepData.summary
            })
          });

          // --- Update session with feedback, summary, score, total time, and chats ---
          const endTime = new Date();
          const startTimeStr = localStorage.getItem('sessionStartTime');
          const startTime = startTimeStr ? new Date(startTimeStr) : new Date();
          const totalTimeMinutes = Math.round((endTime - startTime) / 60000);
          const avgScore = stepData.scores && stepData.scores.length ? (stepData.scores.reduce((a, b) => a + b, 0) / stepData.scores.length) : 0;
          // Build chats array from Q&A and feedback
          const chats = [];
          // Find all Q&A pairs and feedbacks
          let aiIndex = 0, userIndex = 0;
          for (let i = 0; i < stepData.feedbacks.length; i++) {
            // Find the i-th AI question and user answer
            let question = '';
            let answer = '';
            let aiCount = 0, userCount = 0;
            for (let j = 0; j < sessionMessages.length; j++) {
              if (sessionMessages[j].role === 'ai' && !sessionMessages[j].message.startsWith('Feedback') && !sessionMessages[j].message.startsWith('Summary')) {
                if (aiCount === i + 1) { // +1 to skip welcome prompt
                  question = sessionMessages[j].message;
                  break;
                }
                aiCount++;
              }
            }
            for (let j = 0; j < sessionMessages.length; j++) {
              if (sessionMessages[j].role === 'user') {
                if (userCount === i + 1) { // +1 to skip role
                  answer = sessionMessages[j].message;
                  break;
                }
                userCount++;
              }
            }
            chats.push({
              question: question,
              answer: answer,
              ai_feedback: stepData.feedbacks[i],
              score: stepData.scores[i],
              summary: stepData.summary,
              created_at: startTime.toISOString(),
              updated_at: endTime.toISOString()
            });
          }
          await fetch(`http://localhost:5000/api/session/${sessionId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              end_time: endTime.toISOString(),
              total_time_minutes: totalTimeMinutes,
              scores: avgScore,
              summary: stepData.summary,
              chats: chats
            })
          });
          keepGoing = false;
          break;
        }
        // Otherwise, ask next question
        const qBubble = document.createElement('div');
        qBubble.className = 'chat-bubble ai';
        qBubble.textContent = stepData.prompt;
        if (chatHistory) {
          chatHistory.appendChild(qBubble);
          chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        sessionMessages.push({role: 'ai', message: stepData.prompt});
        setInputEnabled(false);
        await speakText(stepData.prompt);
        await new Promise(resolve => setTimeout(resolve, 1000)); // Short pause
        await speakText('Now, please answer.');
        showMicAnimation(true); // Show mic animation and start recording
        const answer = await getVoiceInput('Speak your answer...', 20000); // 20 seconds
        showMicAnimation(false); // Hide mic animation after answer or timeout
        console.log('Recognized answer:', answer);
        if (!answer) {
          const warnBubble = document.createElement('div');
          warnBubble.className = 'chat-bubble ai';
          warnBubble.style.color = 'orange';
          warnBubble.textContent = 'No voice input detected. Please try again or check your microphone.';
          if (chatHistory) {
            chatHistory.appendChild(warnBubble);
            chatHistory.scrollTop = chatHistory.scrollHeight;
          }
          await speakText('No voice input detected. Please try again or check your microphone.');
        }
        answers.push(answer);
        const aBubble = document.createElement('div');
        aBubble.className = 'chat-bubble user';
        aBubble.textContent = answer;
        if (chatHistory) {
          chatHistory.appendChild(aBubble);
          chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        sessionMessages.push({role: 'user', message: answer});
      }
      showMicAnimation(false); // Hide mic animation
      if (startInterviewBtn) {
        startInterviewBtn.disabled = false;
        startInterviewBtn.style.display = 'inline-flex';
      }
    }

    if (startInterviewBtn) {
      startInterviewBtn.addEventListener('click', async function() {
        const sessionId = await createNewSession();
        await runBrowserInterview(sessionId);
      });
    }

    function showMicAnimation(show) {
      const micAnimationOverlay = document.getElementById('micAnimationOverlay');
      if (micAnimationOverlay) {
        micAnimationOverlay.style.display = show ? 'flex' : 'none';
      }
    }
    </script>
</body>
</html> 